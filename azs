#!/usr/bin/env sh
# Cross-platform shim for azs CLI (mirrors azs.cmd behavior)
# Prefer installed azs on PATH; fallback to running the Python module.

if command -v azs >/dev/null 2>&1; then
  exec azs "$@"
fi

if command -v python3 >/dev/null 2>&1; then
  PY=python3
elif command -v python >/dev/null 2>&1; then
  PY=python
else
  echo "python interpreter not found in PATH" >&2
  exit 127
fi

# Ensure required deps are installed (best-effort), with venv fallback
NEEDED_MODS="yaml pandas flask pytds sqlparse sqlglot werkzeug"
need_install=0
for mod in $NEEDED_MODS; do
  "$PY" -c "import $mod" >/dev/null 2>&1 || { need_install=1; break; }
done

if [ "$need_install" -eq 1 ] && [ -f "requirements.txt" ]; then
  echo "[azs] Dependencies missing. Attempting to install from requirements.txt..." >&2
  if "$PY" -m pip install -r requirements.txt --disable-pip-version-check >/dev/null 2>&1; then
    need_install=0
  else
    echo "[azs] System install failed (PEP 668 or permissions)." >&2
    # Try user install
    if "$PY" -m pip install --user -r requirements.txt --disable-pip-version-check >/dev/null 2>&1; then
      need_install=0
    else
      need_install=1
    fi
  fi
fi

if [ "$need_install" -eq 1 ] && [ -f "requirements.txt" ]; then
  echo "[azs] Create a local virtual environment at .venv and install there? [Y/n]" >&2
  # Read from tty if available to avoid piping issues
  if [ -t 0 ]; then
    read ans
  else
    ans="Y"
  fi
  case "$ans" in
    n|N|no|No)
      echo "[azs] Skipping venv creation. You may run: $PY -m pip install -r requirements.txt" >&2
      ;;
    *)
      echo "[azs] Creating .venv and installing deps..." >&2
      if "$PY" -m venv .venv >/dev/null 2>&1; then
        # shellcheck disable=SC1091
        if [ -f .venv/bin/activate ]; then . .venv/bin/activate; fi
        VENV_PY=".venv/bin/python"
        if [ ! -x "$VENV_PY" ]; then VENV_PY="$PY"; fi
        if "$VENV_PY" -m pip install -U pip >/dev/null 2>&1 && \
           "$VENV_PY" -m pip install -r requirements.txt >/dev/null 2>&1; then
          PY="$VENV_PY"
          echo "[azs] Using virtual environment at .venv" >&2
        else
          echo "[azs] Failed to install dependencies in .venv" >&2
        fi
      else
        echo "[azs] Failed to create virtual environment (.venv)" >&2
      fi
      ;;
  esac
fi

exec "$PY" -m pyazs.cli "$@"


