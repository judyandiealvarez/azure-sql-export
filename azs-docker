#!/usr/bin/env bash
set -euo pipefail

# azs-docker: run azs commands inside Docker with msodbcsql18 installed
# Usage: ./azs-docker <command> [args]
# Example: ./azs-docker sync -c config.yaml

if ! command -v docker >/dev/null 2>&1; then
  echo "[azs-docker] docker not found in PATH" >&2
  exit 127
fi

if [ $# -lt 1 ]; then
  echo "usage: ./azs-docker <command> [args]" >&2
  exit 2
fi

CMD="$1"; shift || true
DO_ARGS="$*"

# Build reusable image if missing
IMG="pyazs-runtime:latest"
if ! docker image inspect "$IMG" >/dev/null 2>&1; then
  echo "[azs-docker] Building runtime image..." >&2
  docker build -q -t "$IMG" -f Dockerfile.azs . >/dev/null
fi

# Use Debian-based Python image and install msodbcsql18 and python deps
docker run --rm -t \
  -v "$PWD":/work \
  -w /work \
  "$IMG" pyazs.${CMD} ${DO_ARGS}

echo "[azs-docker] Done. Outputs are in your local working directory (bind-mounted)."


